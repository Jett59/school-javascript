<html>

<head>
    <title>Home - Note Manager</title>
    <script src="helper.js"></script>
    <script>
        // Refresh the page so that the "confirm form resubmition" dialogue doesn't appear.
        // https://stackoverflow.com/a/59301873
        if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
        }
    </script>
</head>

<body>
    <h1>Welcome to your notes!</h1>
    <div id="notes">Loading...</div>
    <form onsubmit="handleCreate(event)" id="create-form">
        <input type="text" name="title" id="titleBox" placeholder="Title" required />
        <input type="submit" value="Create Note" />
    </form>
    <script>
        apiFetch('/api/list', response => {
            if (response.status === 'success') {
                const notes = response.notes;
                const output = document.getElementById('notes');
                output.innerHTML = '';
                if (notes.length > 0) {
                    for (let note of notes) {
                        addNote(note);
                    }
                } else {
                    output.innerHTML = `
                    <h2>No notes yet!</h2>
                    <p>Create one by clicking the button below!</p>
                `;
                }
            } else {
                window.location = '/login.html';
            }
        });

        let notes = [];

        function addNote(note) {
            const output = document.getElementById('notes');
            if (notes.length === 0) {
                output.innerHTML = '';
            }
            notes.push(note);
            let noteDiv = document.createElement('div');
            noteDiv.id = 'note' + note.id;
            noteDiv.innerHTML = `
                        <h2 id="title-${note.id}">${note.title}</h2>
                        <p>${note.content.substring(0, 100)}</p>
                        <button onclick="editNote('${noteDiv.id}', '${note.id}')">Edit</button>
                        <button onclick="deleteNote('${note.id}')">Delete</button>
                    `;
            output.appendChild(noteDiv);
        }

        function handleCreate(event) {
            event.preventDefault();
            const title = document.getElementById('titleBox').value;
            document.getElementById('create-form').reset();
            apiFetch('/api/create', response => {
                const id = response.id;
                addNote({
                    id: id,
                    title: title,
                    content: ''
                });
                editNote(`note${id}`, id);
            }, {
                method: 'POST',
                body: `title=${title}`
            });
        }

        function deleteNote(id) {
            apiFetch(`/api/delete?id=${id}`, response => {
                if (response.status === 'success') {
                    document.location.reload();
                } else {
                    window.location = '/login.html';
                }
            });
        }

        function editNote(parentElementId, noteId) {
            if (document.getElementById(`edit-${noteId}`) === null) {
                const parentElement = document.getElementById(parentElementId);
                const element = document.createElement('div');
                parentElement.appendChild(element);
                apiFetch(`/api/get?id=${noteId}`, response => {
                    if (response.status === 'success') {
                        const note = response.note;
                        element.id = `edit-${noteId}`;
                        element.innerHTML = `
                        <input type="text" id="edit-title-${note.id}" value="${note.title.replace(/\"/g, '&quot;')}" required />
                        <br/>
                        <textarea id="edit-content-${note.id}">${note.content}</textarea>
                        <button onclick="closeEdit('${note.id}')">Done</button>
                `;
                        // Set up autosave for the title and content.
                        initAutosave(note.id);
                        const textbox = element.querySelector('textarea');
                        // Put focus on the text box so they can start typing.
                        textbox.focus();
                    } else {
                        window.location = '/login.html';
                    }
                });
            }
        }

        function initAutosave(id) {
            const titleBox = document.getElementById(`edit-title-${id}`);
            const contentBox = document.getElementById(`edit-content-${id}`);
            const saveHandler = () => {
                if (titleBox.value !== '') {
                    apiFetch('/api/update', response => {
                        if (response.status === "access denied") {
                            window.location = '/login.html';
                        }
                    }, {
                        method: "POST",
                        Headers: {
                            Accept: 'application/json',
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `id=${encodeURIComponent(id)}&title=${encodeURIComponent(titleBox.value)}&content=${encodeURIComponent(contentBox.value)}`
                    });
                }
            };
            const saveThrottle = throttle(1000, saveHandler);
            titleBox.addEventListener('input', () => saveThrottle());
            contentBox.addEventListener('input', () => saveThrottle());
        }

        function closeEdit(id) {
            const titleBox = document.getElementById(`edit-title-${id}`);
            const title = titleBox.value;
            document.getElementById(`edit-${id}`).remove();
            if (title.length > 0) {
                document.getElementById(`title-${id}`).innerHTML = title;
            }
        }
    </script>
</body>

</html>